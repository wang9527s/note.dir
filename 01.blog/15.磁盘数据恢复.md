
### 一、数据恢复

  选错目录，导出数据被删除，尝试使用工具恢复一下；这次记录一下。

  最后选择了[Recuva](https://download.ccleaner.com/rcsetup153.exe)进行数据恢复
指定恢复的目录，开始扫描，文件列表中基本包含了所有的文件；但有接近一半的文件大小都是0(没有被覆盖，无法恢复)。
数据恢复软件

+ 为什么没被覆盖，文件大小为0？

  查询到和SSD的TRIM机制有关。  

  win10一般默认开启trim指令，使用SSD固态硬盘时，删除文件后，不仅会删除“目录”，还会把删除区域的所有数据都变成0，全部擦除。

  数据已经被删除，此时关闭TRIM，Recuva也不可以检测到更多的数据，用于恢复。

+ TRIM状态

  管理员身份运行PowerShell

```bash
	# 查看trim是否开启   0 代表开启 1代表关闭
	PS C:\Windows\system32> fsutil behavior query disabledeletenotify
	NTFS DisableDeleteNotify = 0  (允许将 TRIM 操作发送到存储设备)
	ReFS DisableDeleteNotify = 0  (允许将 TRIM 操作发送到存储设备)

	# 关闭TRIM
	PS C:\Windows\system32> fsutil behavior set disabledeletenotify 1
	NTFS DisableDeleteNotify = 1  (不允许将 TRIM 操作发送到存储设备)
```

  refs是弹性文件系统

### 二、SSD

#### 存储结构 

SSD 存储结构分为单元、页、块三层，下面依次介绍：

+   **单元（cell）**：单元是 SSD 存储的最小单位，由于采用的闪存类型不同，各类闪存中的单元能存储的数据也不同，目前有三种闪存单元类型：
    
    +   单层单元（SLC），这种的晶体管只能存储 1 个比特但寿命很长。
    +   多层单元（MLC），这种的晶体管可以存储 2 个比特，但是会导致增 加延迟时间和相对于SLC减少寿命。
    +   三层单元（TLC），这种的晶体管可以保存 3 个比特，但是会有更高的延迟时间和更短的寿命。
+   **页（page）**：页由许多单元组成，是我们读写 SSD 的最小单位，大多数硬盘的页大小是 2KB、4KB、8 KB 或 16 KB。当我们读 SSD 的数据时，最少读取一页（就算我们只需要 1 字节的数据）；当我们写数据时，就算只需要写 1 字节，也会写一页，因此存在**写入放大**的问题。**页不能被重复写**。
    
+   **块（block）**：块由许多页组成，是数据擦除的最小单元，大多数SSD每个块有128或256个页。这即表示一个块的大小可能在 256 KB 到 4 MB 之间。之前我们说过，页不能被重复写，要修改页的数据，必须先将页所在的块擦除，然后再重新写入新值（块中其他叶需要缓存然后再写入）。




#### TRIM机制


  参考[什么是固态硬盘的TRIM](https://zhuanlan.zhihu.com/p/612220472)

  SSD特点：写入速度快，擦除速度慢，写入前必须要先擦除数据。  
  Trim（Disable Delete Notify）：是定期擦除“被标记为不再使用的数据块”。  
  即，删除的数据并不是直接删除，因为需要一个复杂的过程来确定何时删除。  

  GC: 垃圾回收，“转移正在使用的也到新的块中”。

  TRIM是由Windows自动发出的，当你永久删除一个文件时(即从回收站中删除它)，TRIM命令被添加到一个队列中，并在SSD准备就绪时进行处理——什么时候准备就绪？当系统空闲时，或者你直接选择“优化”SSD时。

+ ssd何时进行擦除操作 
  
  ？？ TODO 待确认 （Bing Ai）
  消费级固态硬盘方案喜欢在系统空闲时处理擦除，而企业级SSD通常在写入时处理擦除操作
  
  查阅资料，没发现一个统一的说法。

+ 似乎可以恢复

  部分型号的SSD此时仍然可以进行数据恢复。  
  [固态硬盘的Trim还想骗我们多久？](https://freewechat.com/a/MzIwMDUyNzM0NA==/2247484235/1)，中介绍。如果拆除磁盘、进行短接，是可以恢复数据的。  
  即，SSD收到Trim指令后，SSD的主控开始对操作系统进行“欺骗”；给操作系统的确确实实是该文件被清零删除了，但其实主控此时并没有向硬盘发送Trim，所以文件底层的数据还未被清零！

	
	    