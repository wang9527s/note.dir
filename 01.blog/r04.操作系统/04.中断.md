
### 前言：异常控制流

每个进程对应的程序文件由一条一条的指令组成。进程在执行的时候，会将程序文件加载到进程的内存空间中，这些指令在内存空间中是相邻的。进程会通过调整程序计数器 PC 的值，一条一条地执行指令。我们将进程执行的指令序列叫做处理器的「控制流」。

正常情况下，进程可能会顺序执行相邻的指令（“平滑的”序列），也可能通过跳转、调用和返回等程序指令转移到另一个位置开始执行（平滑流的突变）。无论是前者还是后者，都是程序正常执行的结果，是可以预知的、符合预期的。

但是，系统中也会发生一些异常情况。处理这些异常时，会打断进程正常执行的控制流，转而执行相应的处理程序，执行完毕再返回。我们将这类突变称为「异常控制流」（Exceptional Control Flow，ECF）。

异常控制流的形式有以下几种：陷阱、中断与异常。此外还有信号，这是一种更高层的异常形式，也会改变进程的控制流。

### 陷阱（trap）

陷阱是有意造成的“异常”，是执行一条指令的结果。陷阱是同步的。

陷阱的主要作用是实现系统调用。

每个系统调用有一个唯一的整数号，对应于内核中一个跳转表的偏移量。这个跳转表中的每个条目表示一个系统调用的代码位置。执行系统调用时，通过这个整数号作为跳转表的偏移量，就可以执行相应的系统调用。

**陷阱**也被称为**软中断**，它不是真正意义上的中断，但是和硬件中断的处理流程类似。

### 中断（interrupt）
  
（硬件）中断是由硬件设备触发的中断，如时钟中断、外部中断等。

硬件中断具有实时性强、可靠性高、处理速度快等特点。直接由硬件给出相关条件，不占用cpu执行时间。

中断是**异步**的、无法预期的事件

每个中断都有一个中断号。操作系统使用**中断描述符表**（Interrupt Descriptor Table，IDT）来保存每个中断的中断处理程序的地址。当发生中断时，操作系统会根据中断号，在中断描述表中查找并执行相应的中断处理程序。
  
+ 中断特点

   中断处理程序运行在中断上下文中。中断上下文也被称为原子上下文，因为该上下文中执行的代码是**不可阻塞**、**不可被打断**。

   中断上下文不可以睡眠，所以中断上下文中的代码中，不允许使用睡眠函数。

   中断处理不许迅速。尽量把工作分离出来放到下半部执行，因为下半部可以在更合适的实现来执行。

+ 中断的流程

  发生中断 -> 保存现场 -> 处理中断 -> 恢复现场

#### 中断处理程序

产生中断的每个设备都有一个相应的中断处理程序，包含在该设备的驱动程序中（如果一个设备可以产生多种不同的中断，那么这个设备就可以对应多个中断处理程序，该设备的驱动程序就需要准备多个中断处理函数）。中断处理函数与其余内核函数的区别在于，中断处理程序是用于被内核调用来响应中断的，运行在被称为中断上下文的特殊上下文中（偶尔也被称为原子上下文），该上下文中执行的代码不可阻塞。



### 异常

在《深入理解计算机系统》中提到，异常是异常控制流的一种，一部分由硬件实现，一部分由操作系统实现。异常是控制流中的**突变**，通常是一些错误，比如除法异常、缺页异常等。  
在异常处理程序处理完成后，将控制返回给被中断的程序或者终止。

+ 中断和异常

  中断理解为是一个被外部I/O设备触发的异步事件，由硬件设备生成，然后通过中断控制器传递给 CPU，CPU 有两个特殊的引脚 NMI 和 INTR 负责接收中断信号。  
  异常则是一个同步的事件，通常由程序的错误产生的，或是由内核必须处理的异常条件产生的，如缺页异常或 syscall 等。  

## 其他

### TODO

md，好多blog上说的都不太一样。下次再完善！

### 软件中断

软件中断(Software Interrupt)，从软件中断指令而来。在32位x86中，为了实现linux用户态到内核态的切换，linux使用软中断指令“int 0x80”来触发异常，切换CPU特权级，实现系统调用。
  
软件中断是由软件程序触发的中断，如系统调用、软中断、异常等。

### 中断的上下部分

+ 上半部分（Top Half）：

上半部分是硬件中断处理的第一阶段，也是紧急响应阶段。
当处理器接收到硬件中断信号时，会立即跳转到上半部分的中断服务程序（ISR）来处理中断。
上半部分的主要目标是尽快地响应中断，执行与中断直接相关的紧急任务，并尽可能快速地完成，以减少对系统的影响。
上半部分通常包括与硬件设备通信、缓冲区处理等与中断直接相关的任务。

+ 下半部分（Bottom Half）：

下半部分是硬件中断处理的第二阶段，也是延迟响应阶段，可称为。
在上半部分完成紧急任务后，处理器会将控制权转移到下半部分来处理较为耗时的任务，或者需要延迟执行的任务。
下半部分通常包括与中断事件相关的后续处理、资源释放、数据整理等任务，这些任务可能需要更长的时间来完成，但并不需要立即执行。
下半部分的执行通常在上半部分完成之后，可能在稍后的时间点、或者在系统空闲时执行，以避免对系统的影响过大。


## 参考资料

+ [【操作系统】陷阱、中断、异常、信号](https://imageslr.com/2020/07/09/trap-interrupt-exception.html)  
+ [一文了解 OS-中断](https://anyview.fun/2022/11/28/一文了解os-中断/)
+ [什么是软中断？](https://www.xiaolincoding.com/os/1_hardware/soft_interrupt.html#%E4%B8%AD%E6%96%AD%E6%98%AF%E4%BB%80%E4%B9%88)